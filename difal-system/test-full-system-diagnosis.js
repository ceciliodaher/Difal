const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');

// Arquivo SPED real para teste
const SPED_FILE_PATH = '/Users/ceciliodaher/Documents/git/difal/documentos/13158698000110-106379704-20250101-20250131-1-DED4E284399363BC7F1F48E5A39EE85261E47B67-SPED-EFD.txt';

// Diret√≥rio para screenshots e logs
const TEST_RESULTS_DIR = path.join(__dirname, 'test-results', `diagnosis-${Date.now()}`);

// Criar diret√≥rio de resultados
if (!fs.existsSync(TEST_RESULTS_DIR)) {
    fs.mkdirSync(TEST_RESULTS_DIR, { recursive: true });
}

// Logger especializado para diagn√≥stico
class DiagnosticLogger {
    constructor() {
        this.results = {
            timestamp: new Date().toISOString(),
            issues: [],
            successes: [],
            screenshots: [],
            consoleLogs: [],
            errors: [],
            summary: {
                totalIssues: 0,
                criticalIssues: 0,
                systemStatus: 'unknown'
            }
        };
        this.logFile = path.join(TEST_RESULTS_DIR, 'diagnostic-report.json');
    }

    logIssue(severity, component, issue, details = {}) {
        const entry = {
            severity, // 'critical', 'major', 'minor'
            component, // 'navigation', 'upload', 'processing', etc.
            issue,
            details,
            timestamp: new Date().toISOString()
        };
        
        this.results.issues.push(entry);
        if (severity === 'critical') this.results.summary.criticalIssues++;
        this.results.summary.totalIssues++;
        
        console.log(`‚ùå [${severity.toUpperCase()}] ${component}: ${issue}`);
    }

    logSuccess(component, test, details = {}) {
        const entry = {
            component,
            test,
            details,
            timestamp: new Date().toISOString()
        };
        
        this.results.successes.push(entry);
        console.log(`‚úÖ ${component}: ${test}`);
    }

    logScreenshot(name, description) {
        this.results.screenshots.push({ name, description });
    }

    logConsole(type, message) {
        this.results.consoleLogs.push({
            type,
            message,
            timestamp: new Date().toISOString()
        });
    }

    logError(error, context) {
        this.results.errors.push({
            error: error.message,
            stack: error.stack,
            context,
            timestamp: new Date().toISOString()
        });
    }

    generateSummary() {
        const totalTests = this.results.issues.length + this.results.successes.length;
        const successRate = totalTests > 0 ? (this.results.successes.length / totalTests) * 100 : 0;
        
        this.results.summary.systemStatus = 
            this.results.summary.criticalIssues === 0 && successRate > 80 ? 'functional' :
            this.results.summary.criticalIssues > 0 ? 'broken' :
            'partially-functional';
        
        this.results.summary.successRate = successRate;
        this.results.summary.totalTests = totalTests;
    }

    save() {
        this.generateSummary();
        fs.writeFileSync(this.logFile, JSON.stringify(this.results, null, 2));
        console.log(`\nüìä Relat√≥rio de diagn√≥stico salvo em: ${this.logFile}`);
        
        // Sum√°rio no console
        console.log('\n=== SUM√ÅRIO DO DIAGN√ìSTICO ===');
        console.log(`Status do Sistema: ${this.results.summary.systemStatus}`);
        console.log(`Taxa de Sucesso: ${this.results.summary.successRate.toFixed(1)}%`);
        console.log(`Problemas Cr√≠ticos: ${this.results.summary.criticalIssues}`);
        console.log(`Total de Problemas: ${this.results.summary.totalIssues}`);
    }
}

async function runFullSystemDiagnosis() {
    const logger = new DiagnosticLogger();
    const browser = await chromium.launch({ 
        headless: false,
        slowMo: 1000 // Mais lento para observar comportamento
    });
    
    const context = await browser.newContext({
        viewport: { width: 1280, height: 720 }
    });
    
    const page = await context.newPage();
    
    // Limpar localStorage para teste limpo
    await page.addInitScript(() => {
        localStorage.clear();
        sessionStorage.clear();
    });
    
    // Capturar logs do console
    page.on('console', msg => {
        logger.logConsole(msg.type(), msg.text());
    });
    
    // Capturar erros da p√°gina
    page.on('pageerror', error => {
        logger.logError(error, 'page-error');
    });

    try {
        // ========== TESTE 1: CARREGAMENTO INICIAL ==========
        console.log('\nüîç TESTE 1: Carregamento inicial da aplica√ß√£o');
        
        await page.goto('file://' + path.resolve(__dirname, 'sistema.html'));
        await page.waitForLoadState('networkidle');
        await page.waitForTimeout(2000);
        
        const screenshotPath = path.join(TEST_RESULTS_DIR, '01-initial-load.png');
        await page.screenshot({ path: screenshotPath, fullPage: true });
        logger.logScreenshot('01-initial-load.png', 'Estado inicial da aplica√ß√£o');

        // ========== TESTE 2: TELA DE SELE√á√ÉO DE MODO ==========
        console.log('\nüîç TESTE 2: Verifica√ß√£o da tela de sele√ß√£o de modo');
        
        const modeSelectionVisible = await page.locator('#mode-selection-section').isVisible();
        if (modeSelectionVisible) {
            logger.logSuccess('mode-selection', 'Tela de sele√ß√£o vis√≠vel na inicializa√ß√£o');
        } else {
            logger.logIssue('critical', 'mode-selection', 'Tela de sele√ß√£o n√£o aparece na inicializa√ß√£o');
            
            // Verificar qual se√ß√£o est√° ativa
            const activeSections = await page.locator('.section.active, .section[style*="block"]').all();
            const activeSectionIds = [];
            for (const section of activeSections) {
                const id = await section.getAttribute('id');
                if (id) activeSectionIds.push(id);
            }
            logger.logIssue('major', 'mode-selection', 'Se√ß√µes ativas encontradas', { activeSections: activeSectionIds });
        }

        // ========== TESTE 3: NAVEGA√á√ÉO INICIAL ==========
        console.log('\nüîç TESTE 3: Verifica√ß√£o da navega√ß√£o');
        
        const navigationVisible = await page.locator('#main-navigation').isVisible();
        if (navigationVisible) {
            logger.logSuccess('navigation', 'Navega√ß√£o vis√≠vel');
        } else {
            logger.logIssue('critical', 'navigation', 'Navega√ß√£o n√£o est√° vis√≠vel');
        }
        
        const navButtons = await page.locator('.nav-btn').count();
        if (navButtons > 0) {
            logger.logSuccess('navigation', `${navButtons} bot√µes de navega√ß√£o encontrados`);
        } else {
            logger.logIssue('critical', 'navigation', 'Nenhum bot√£o de navega√ß√£o encontrado');
        }

        // ========== TESTE 4: SELE√á√ÉO DE MODO (se dispon√≠vel) ==========
        console.log('\nüîç TESTE 4: Teste de sele√ß√£o de modo');
        
        if (modeSelectionVisible) {
            const singleModeCard = page.locator('#single-mode-card');
            const cardVisible = await singleModeCard.isVisible();
            
            if (cardVisible) {
                logger.logSuccess('mode-selection', 'Card single-period vis√≠vel');
                await singleModeCard.click();
                await page.waitForTimeout(1000);
                
                const screenshotPath2 = path.join(TEST_RESULTS_DIR, '02-mode-selected.png');
                await page.screenshot({ path: screenshotPath2, fullPage: true });
                logger.logScreenshot('02-mode-selected.png', 'Ap√≥s sele√ß√£o do modo single-period');
                
                // Verificar se navega√ß√£o apareceu
                const navVisibleAfterMode = await page.locator('#main-navigation').isVisible();
                if (navVisibleAfterMode) {
                    logger.logSuccess('navigation', 'Navega√ß√£o aparece ap√≥s sele√ß√£o de modo');
                } else {
                    logger.logIssue('critical', 'navigation', 'Navega√ß√£o n√£o aparece ap√≥s sele√ß√£o de modo');
                }
            } else {
                logger.logIssue('major', 'mode-selection', 'Card single-period n√£o est√° vis√≠vel');
            }
        }

        // ========== TESTE 5: SE√á√ÉO DE UPLOAD ==========
        console.log('\nüîç TESTE 5: Verifica√ß√£o da se√ß√£o de upload');
        
        const uploadSectionVisible = await page.locator('#single-upload-section').isVisible();
        if (uploadSectionVisible) {
            logger.logSuccess('upload', 'Se√ß√£o de upload single-period vis√≠vel');
        } else {
            logger.logIssue('critical', 'upload', 'Se√ß√£o de upload n√£o est√° vis√≠vel');
        }
        
        const fileInput = page.locator('#file-input');
        const fileInputExists = await fileInput.count() > 0;
        if (fileInputExists) {
            logger.logSuccess('upload', 'Input de arquivo existe');
        } else {
            logger.logIssue('critical', 'upload', 'Input de arquivo n√£o encontrado');
        }
        
        const dropZone = page.locator('#drop-zone');
        const dropZoneVisible = await dropZone.isVisible();
        if (dropZoneVisible) {
            logger.logSuccess('upload', 'Zona de drop vis√≠vel');
        } else {
            logger.logIssue('major', 'upload', 'Zona de drop n√£o est√° vis√≠vel');
        }

        // ========== TESTE 6: UPLOAD DE ARQUIVO ==========
        console.log('\nüîç TESTE 6: Teste de upload de arquivo');
        
        if (fileInputExists) {
            try {
                await fileInput.setInputFiles(SPED_FILE_PATH);
                await page.waitForTimeout(3000); // Aguardar processamento
                
                const screenshotPath3 = path.join(TEST_RESULTS_DIR, '03-file-uploaded.png');
                await page.screenshot({ path: screenshotPath3, fullPage: true });
                logger.logScreenshot('03-file-uploaded.png', 'Ap√≥s upload do arquivo SPED');
                
                logger.logSuccess('upload', 'Arquivo SPED enviado com sucesso');
            } catch (error) {
                logger.logIssue('critical', 'upload', 'Falha no upload do arquivo', { error: error.message });
            }
        }

        // ========== TESTE 7: DADOS EXTRA√çDOS ==========
        console.log('\nüîç TESTE 7: Verifica√ß√£o dos dados extra√≠dos');
        
        const summarySection = page.locator('#sped-summary');
        const summaryVisible = await summarySection.isVisible();
        if (summaryVisible) {
            logger.logSuccess('processing', 'Se√ß√£o de resumo SPED vis√≠vel');
        } else {
            logger.logIssue('critical', 'processing', 'Se√ß√£o de resumo SPED n√£o aparece');
        }
        
        const companyInfo = page.locator('.summary-item').filter({ hasText: 'Empresa' });
        const companyInfoVisible = await companyInfo.count() > 0;
        if (companyInfoVisible) {
            const companyText = await companyInfo.first().textContent();
            logger.logSuccess('processing', 'Informa√ß√µes da empresa extra√≠das', { text: companyText });
        } else {
            logger.logIssue('critical', 'processing', 'Informa√ß√µes da empresa n√£o foram extra√≠das');
        }

        // ========== TESTE 8: NAVEGA√á√ÉO ENTRE SE√á√ïES ==========
        console.log('\nüîç TESTE 8: Teste de navega√ß√£o entre se√ß√µes');
        
        const analysisButton = page.locator('[data-section="single-analysis-section"]');
        const analysisButtonVisible = await analysisButton.isVisible();
        if (analysisButtonVisible) {
            logger.logSuccess('navigation', 'Bot√£o de an√°lise vis√≠vel');
            
            try {
                await analysisButton.click();
                await page.waitForTimeout(1000);
                
                const analysisSectionVisible = await page.locator('#single-analysis-section').isVisible();
                if (analysisSectionVisible) {
                    logger.logSuccess('navigation', 'Navega√ß√£o para se√ß√£o de an√°lise funciona');
                } else {
                    logger.logIssue('major', 'navigation', 'Navega√ß√£o para an√°lise n√£o funciona');
                }
                
                const screenshotPath4 = path.join(TEST_RESULTS_DIR, '04-analysis-section.png');
                await page.screenshot({ path: screenshotPath4, fullPage: true });
                logger.logScreenshot('04-analysis-section.png', 'Se√ß√£o de an√°lise');
                
            } catch (error) {
                logger.logIssue('major', 'navigation', 'Erro ao clicar no bot√£o de an√°lise', { error: error.message });
            }
        } else {
            logger.logIssue('critical', 'navigation', 'Bot√£o de an√°lise n√£o est√° vis√≠vel');
        }

        // ========== TESTE 9: SE√á√ÉO DE C√ÅLCULO ==========
        console.log('\nüîç TESTE 9: Teste da se√ß√£o de c√°lculo');
        
        const calculationButton = page.locator('[data-section="single-calculation-section"]');
        const calculationButtonVisible = await calculationButton.isVisible();
        if (calculationButtonVisible) {
            logger.logSuccess('navigation', 'Bot√£o de c√°lculo vis√≠vel');
            
            try {
                await calculationButton.click();
                await page.waitForTimeout(1000);
                
                const calculationSectionVisible = await page.locator('#single-calculation-section').isVisible();
                if (calculationSectionVisible) {
                    logger.logSuccess('navigation', 'Navega√ß√£o para se√ß√£o de c√°lculo funciona');
                    
                    const calculateButton = page.locator('#calculate-difal');
                    const calculateButtonVisible = await calculateButton.isVisible();
                    if (calculateButtonVisible) {
                        logger.logSuccess('calculation', 'Bot√£o calcular DIFAL vis√≠vel');
                    } else {
                        logger.logIssue('major', 'calculation', 'Bot√£o calcular DIFAL n√£o est√° vis√≠vel');
                    }
                } else {
                    logger.logIssue('major', 'navigation', 'Navega√ß√£o para c√°lculo n√£o funciona');
                }
                
                const screenshotPath5 = path.join(TEST_RESULTS_DIR, '05-calculation-section.png');
                await page.screenshot({ path: screenshotPath5, fullPage: true });
                logger.logScreenshot('05-calculation-section.png', 'Se√ß√£o de c√°lculo');
                
            } catch (error) {
                logger.logIssue('major', 'navigation', 'Erro ao navegar para c√°lculo', { error: error.message });
            }
        } else {
            logger.logIssue('critical', 'navigation', 'Bot√£o de c√°lculo n√£o est√° vis√≠vel');
        }

        // ========== TESTE 10: SCREENSHOT FINAL ==========
        const finalScreenshot = path.join(TEST_RESULTS_DIR, '06-final-state.png');
        await page.screenshot({ path: finalScreenshot, fullPage: true });
        logger.logScreenshot('06-final-state.png', 'Estado final do sistema');

        console.log('\n‚úÖ Diagn√≥stico completo finalizado!');
        
    } catch (error) {
        logger.logError(error, 'system-diagnosis');
        console.error('‚ùå Erro durante diagn√≥stico:', error);
        
        const errorScreenshot = path.join(TEST_RESULTS_DIR, 'error-state.png');
        await page.screenshot({ path: errorScreenshot, fullPage: true });
        logger.logScreenshot('error-state.png', 'Estado de erro');
    } finally {
        logger.save();
        await browser.close();
        
        console.log(`\nüìÅ Resultados completos em: ${TEST_RESULTS_DIR}`);
        
        // Determinar pr√≥ximos passos baseado nos resultados
        if (logger.results.summary.criticalIssues > 0) {
            console.log('\nüö® PROBLEMAS CR√çTICOS ENCONTRADOS - Sistema precisa de corre√ß√µes urgentes');
            console.log('Pr√≥ximos passos sugeridos:');
            logger.results.issues
                .filter(i => i.severity === 'critical')
                .forEach(issue => {
                    console.log(`  - ${issue.component}: ${issue.issue}`);
                });
        } else if (logger.results.summary.successRate < 80) {
            console.log('\n‚ö†Ô∏è Sistema parcialmente funcional - Algumas corre√ß√µes necess√°rias');
        } else {
            console.log('\n‚úÖ Sistema funcionando adequadamente!');
        }
    }
}

// Executar diagn√≥stico
runFullSystemDiagnosis()
    .then(() => {
        console.log('\nüîç DIAGN√ìSTICO COMPLETO FINALIZADO!');
        process.exit(0);
    })
    .catch(error => {
        console.error('\nüí• FALHA NO DIAGN√ìSTICO:', error.message);
        console.log('Verifique os logs para mais detalhes.');
        process.exit(1);
    });