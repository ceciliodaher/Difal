<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema DIFAL - Expertzy</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS Modular -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/sections.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Container Principal -->
    <div class="app-container">
        
        <!-- Header -->
        <header class="app-header">
            <div class="expertzy-logo">
                <img src="assets/logo-expertzy.png" alt="Expertzy Logo" onerror="this.style.display='none'">
                <span class="brand-text">EXPERTZY</span>
            </div>
            <h1 class="app-title">Sistema de C√°lculo DIFAL</h1>
            <p class="app-subtitle">Diferencial de Al√≠quota do ICMS - Opera√ß√µes Interestaduais</p>
        </header>

        <!-- Navega√ß√£o -->
        <nav class="nav-container">
            <button class="nav-btn active" data-section="upload-section">
                <span class="nav-icon">üìÅ</span>
                <span class="nav-label">Upload</span>
            </button>
            <button class="nav-btn" data-section="analysis-section">
                <span class="nav-icon">üîç</span>
                <span class="nav-label">An√°lise</span>
            </button>
            <button class="nav-btn" data-section="calculation-section">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">C√°lculo</span>
            </button>
        </nav>

        <!-- Conte√∫do Principal -->
        <main class="main-content">
            
            <!-- Se√ß√£o 1: Upload de Arquivo -->
            <section id="upload-section" class="section active">
                <div class="section-card">
                    <h2 class="section-title">üìÅ Upload do Arquivo SPED</h2>
                    
                    <!-- Drop Zone -->
                    <div id="drop-zone" class="drop-zone">
                        <div class="drop-zone-content">
                            <svg class="drop-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <p class="drop-text">Arraste o arquivo SPED aqui ou clique para selecionar</p>
                            <p class="drop-hint">Arquivo TXT do SPED Fiscal</p>
                            <input type="file" id="file-input" accept=".txt" style="display: none;">
                        </div>
                    </div>

                    <!-- Informa√ß√µes do Arquivo -->
                    <div id="file-info" class="file-info hidden">
                        <h3>Informa√ß√µes do Arquivo</h3>
                        <div id="file-details" class="file-details">
                            <!-- Dados ser√£o inseridos via JavaScript -->
                        </div>
                    </div>

                    <!-- Resumo SPED -->
                    <div id="sped-summary" class="sped-summary hidden">
                        <h3>Resumo dos Dados SPED</h3>
                        <div class="summary-grid">
                            <!-- Dados ser√£o inseridos via JavaScript -->
                        </div>
                    </div>

                    <!-- Bot√£o Prosseguir -->
                    <div class="action-buttons">
                        <button id="proceed-calculation" class="btn btn-primary btn-large hidden">
                            Prosseguir para An√°lise ‚Üí
                        </button>
                    </div>
                </div>
            </section>

            <!-- Se√ß√£o 2: An√°lise dos Dados -->
            <section id="analysis-section" class="section">
                <div class="section-card">
                    <h2 class="section-title">üîç An√°lise dos Itens DIFAL</h2>
                    
                    <!-- Informa√ß√µes da Empresa -->
                    <div class="company-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Empresa:</span>
                                <span id="company-name" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">UF:</span>
                                <span id="company-uf" class="info-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Itens DIFAL -->
                    <div id="difal-items-table" class="table-container">
                        <!-- Tabela ser√° inserida via JavaScript -->
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="action-buttons">
                        <button id="calculate-difal" class="btn btn-primary btn-large">
                            üéØ Configurar e Calcular DIFAL
                        </button>
                        <button id="proceed-to-calculation" class="btn btn-info">
                            Prosseguir para C√°lculo ‚Üí
                        </button>
                        <button class="btn btn-secondary nav-btn" data-section="upload-section">
                            ‚Üê Voltar para Upload
                        </button>
                    </div>
                </div>
            </section>

            <!-- Se√ß√£o 3: Configura√ß√£o e C√°lculo -->
            <section id="calculation-section" class="section">
                <div class="section-card">
                    <h2 class="section-title">‚öôÔ∏è Configura√ß√£o e C√°lculo</h2>
                    
                    <!-- Progress Section -->
                    <div id="progress-section" class="progress-section hidden">
                        <div class="progress-container">
                            <div id="progress-bar" class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <p id="status-message" class="status-message">Processando...</p>
                        </div>
                    </div>

                    <!-- Resultados do C√°lculo -->
                    <div id="calculation-results" class="calculation-results hidden">
                        <div id="results-summary" class="results-summary">
                            <!-- Resumo ser√° inserido via JavaScript -->
                        </div>
                        
                        <div id="results-detail" class="results-detail">
                            <!-- Detalhes ser√£o inseridos via JavaScript -->
                        </div>

                        <!-- Bot√µes de Exporta√ß√£o -->
                        <div class="export-buttons">
                            <button id="export-excel" class="btn btn-success">
                                üì• Exportar para Excel
                            </button>
                            <button id="export-pdf" class="btn btn-info">
                                üìÑ Exportar para PDF
                            </button>
                        </div>
                    </div>
                </div>
            </section>


        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>¬© 2025 Expertzy - Sistema de C√°lculo DIFAL v3.0</p>
            <p class="footer-info">C√°lculo conforme legisla√ß√£o vigente - EC 87/2015</p>
        </footer>
    </div>

    <!-- Modal de Configura√ß√£o Geral -->
    <div id="config-modal" class="modal hidden">
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Configura√ß√£o Geral do DIFAL</h2>
                    <button class="modal-close" onclick="closeConfigModal()">√ó</button>
                </div>
                
                <div class="modal-body">
                    <!-- Sele√ß√£o de Metodologia -->
                    <div class="form-section">
                        <h3>üìê Metodologia de C√°lculo</h3>
                        <p class="form-description">Escolha a metodologia de c√°lculo a ser aplicada para todos os itens</p>
                        
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="metodologia" value="auto" checked>
                                <span class="radio-label">
                                    <strong>Autom√°tica</strong>
                                    <small>Sistema define baseado no estado de destino</small>
                                </span>
                            </label>
                            
                            <label class="radio-option">
                                <input type="radio" name="metodologia" value="base-unica">
                                <span class="radio-label">
                                    <strong>Base √önica</strong>
                                    <small>C√°lculo simplificado</small>
                                </span>
                            </label>
                            
                            <label class="radio-option">
                                <input type="radio" name="metodologia" value="base-dupla">
                                <span class="radio-label">
                                    <strong>Base Dupla</strong>
                                    <small>C√°lculo com IPI incluso</small>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Benef√≠cios Fiscais Globais -->
                    <div class="form-section">
                        <h3>üí∞ Benef√≠cios Fiscais Globais</h3>
                        <p class="form-description">Configure benef√≠cios aplic√°veis a todos os itens</p>
                        
                        <div class="form-group">
                            <label for="carga-efetiva">Carga Tribut√°ria Efetiva (%):</label>
                            <input type="number" id="carga-efetiva" value="" min="0" max="100" step="0.01" placeholder="Ex: 4.00">
                            <small class="form-hint">Deixe vazio para n√£o aplicar redu√ß√£o de base. Sistema calcular√° automaticamente o percentual de redu√ß√£o necess√°rio.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="aliq-origem-efetiva">Al√≠quota Origem Efetiva (%):</label>
                            <input type="number" id="aliq-origem-efetiva" value="" min="0" max="100" step="0.01" placeholder="Ex: 10.00">
                            <small class="form-hint">Deixe vazio para usar al√≠quota nominal. Aplic√°vel apenas para Base √önica.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="aliq-destino-efetiva">Al√≠quota Destino Efetiva (%):</label>
                            <input type="number" id="aliq-destino-efetiva" value="" min="0" max="100" step="0.01" placeholder="Ex: 17.00">
                            <small class="form-hint">Deixe vazio para usar al√≠quota nominal.</small>
                        </div>
                    </div>

                    <!-- Configura√ß√µes Avan√ßadas -->
                    <div class="form-section">
                        <h3>üîß Configura√ß√µes Avan√ßadas</h3>
                        
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" id="configurar-beneficios" checked>
                                <span>Configurar benef√≠cios fiscais por item</span>
                            </label>
                            
                            <label class="checkbox-option">
                                <input type="checkbox" id="configurar-fcp-manual">
                                <span>Definir FCP manualmente por item</span>
                            </label>
                        </div>
                    </div>

                    <!-- Percentual do Destinat√°rio -->
                    <div class="form-section">
                        <h3>üìä Partilha do DIFAL</h3>
                        <div class="form-group">
                            <label for="percentual-destinatario">Percentual para o Estado de Destino:</label>
                            <input type="number" id="percentual-destinatario" value="100" min="0" max="100" readonly>
                            <small class="form-hint">Para 2025: 100% para o estado de destino</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeConfigModal()">Cancelar</button>
                    <button class="btn btn-warning" onclick="prosseguirParaConfiguracaoItens()">
                        ‚öôÔ∏è Configurar Itens Individualmente
                    </button>
                    <button class="btn btn-primary" onclick="calcularSemConfiguracaoItens()">
                        üöÄ Calcular Sem Configura√ß√£o Individual
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o Por Item -->
    <div id="item-config-modal" class="modal hidden">
        <div class="modal-overlay">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>üìã Configura√ß√£o Individual por Item</h2>
                    <button class="modal-close" onclick="closeItemConfigModal()">√ó</button>
                </div>
                
                <div class="modal-body">
                    <!-- Filtros -->
                    <div class="filters-section">
                        <div class="filters-grid">
                            <div class="filter-item">
                                <label for="filtro-cfop">CFOP:</label>
                                <select id="filtro-cfop">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="filtro-ncm">NCM:</label>
                                <select id="filtro-ncm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="filtro-valor-min">Valor M√≠nimo:</label>
                                <input type="number" id="filtro-valor-min" placeholder="0.00" min="0" step="0.01">
                            </div>
                            <div class="filter-item">
                                <label for="busca-item">Buscar:</label>
                                <input type="text" id="busca-item" placeholder="C√≥digo ou descri√ß√£o...">
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="aplicarFiltros()">Aplicar Filtros</button>
                            <button class="btn btn-outline btn-sm" onclick="limparFiltros()">Limpar</button>
                        </div>
                    </div>

                    <!-- Resumo -->
                    <div class="config-summary">
                        <div class="summary-stats">
                            <span>Total de Itens: <strong id="total-itens-config">0</strong></span>
                            <span>Com Benef√≠cio: <strong id="itens-com-beneficio">0</strong></span>
                            <span>Valor Total Base: <strong id="valor-total-base">R$ 0,00</strong></span>
                            <span>Configs Salvas: <strong id="configs-localstorage">0</strong></span>
                        </div>
                        <div class="storage-status" id="storage-status">
                            <small>üì± Dados ser√£o mantidos entre sess√µes</small>
                        </div>
                    </div>

                    <!-- Tabela de Configura√ß√£o -->
                    <div class="config-table-container">
                        <table id="tabela-configuracao-itens" class="data-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>NCM</th>
                                    <th>Descri√ß√£o</th>
                                    <th>CFOP</th>
                                    <th>Valor Base</th>
                                    <th>Benef√≠cio</th>
                                    <th>Configura√ß√£o</th>
                                    <th>FCP (%)</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Linhas ser√£o inseridas via JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagina√ß√£o -->
                    <div id="paginacao-config" class="pagination">
                        <button class="btn btn-sm btn-secondary" onclick="paginaAnterior()">‚Üê Anterior</button>
                        <span id="info-pagina" class="page-info">P√°gina 1 de 1</span>
                        <button class="btn btn-sm btn-secondary" onclick="proximaPagina()">Pr√≥ximo ‚Üí</button>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeItemConfigModal()">Cancelar</button>
                    <button class="btn btn-warning" onclick="limparTodasConfiguracoes()">üßπ Limpar Todas</button>
                    <button class="btn btn-info" onclick="salvarConfiguracoesItens()">üíæ Salvar Configura√ß√µes</button>
                    <button class="btn btn-primary" onclick="calcularComConfiguracoesItens()">
                        üéØ Calcular com Configura√ß√µes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Fun√ß√µes inline removidas - migradas para m√≥dulos respectivos:
         - Modal functions ‚Üí js/modal/modal-manager.js
         - Configuration functions ‚Üí js/core/configuration-manager.js  
         - UI functions ‚Üí js/ui-manager.js
    -->
    
    <!-- M√≥dulos Core (Infraestrutura) -->
    <script src="js/core/constants.js"></script>
    <script src="js/core/event-bus.js"></script>
    <script src="js/core/state-manager.js"></script>
    <script src="js/core/logger.js"></script>
    
    <!-- M√≥dulos de Configura√ß√£o -->
    <script src="js/config/configuration-manager.js"></script>
    
    <!-- M√≥dulos Modulares -->
    <script src="data/estados-brasil.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/parsing/sped-parser.js"></script>
    <script src="js/calculation/difal-calculator.js"></script>
    
    <!-- Novos M√≥dulos UI -->
    <script src="js/export/export-manager.js"></script>
    <script src="js/file/file-upload-manager.js"></script>
    <script src="js/modal/modal-manager.js"></script>
    <script src="js/results/results-renderer.js"></script>
    <script src="js/ui/navigation-manager.js"></script>
    <script src="js/ui/progress-manager.js"></script>
    <script src="js/ui/pagination-manager.js"></script>
    
    <!-- UI Manager Principal -->
    <script src="js/ui-manager.js"></script>
    
    <!-- App Principal -->
    <script src="js/app.js"></script>
    
</body>
</html>