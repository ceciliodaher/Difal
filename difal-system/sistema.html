<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema DIFAL - Expertzy</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS Modular -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/sections.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <!-- Container Principal -->
    <div class="app-container">
        
        <!-- Header -->
        <header class="app-header">
            <div class="expertzy-logo">
                <img src="assets/logo-expertzy.png" alt="Expertzy Logo" onerror="this.style.display='none'">
                <span class="brand-text">EXPERTZY</span>
            </div>
            <h1 class="app-title">Sistema de C√°lculo DIFAL</h1>
            <p class="app-subtitle">Diferencial de Al√≠quota do ICMS - Opera√ß√µes Interestaduais</p>
        </header>

        <!-- Navega√ß√£o -->
        <nav class="nav-container hidden" id="main-navigation" style="display: none;">
            <!-- Single-Period Mode Navigation -->
            <button class="nav-btn active mode-single" data-section="single-upload-section">
                <span class="nav-icon">üìÅ</span>
                <span class="nav-label">Upload</span>
            </button>
            <button class="nav-btn mode-single" data-section="single-analysis-section">
                <span class="nav-icon">üîç</span>
                <span class="nav-label">An√°lise</span>
            </button>
            <button class="nav-btn mode-single" data-section="single-calculation-section">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">C√°lculo</span>
            </button>
            <button class="nav-btn mode-single" data-section="single-results-section">
                <span class="nav-icon">üìã</span>
                <span class="nav-label">Resultados</span>
            </button>
            
            <!-- Multi-Period Mode Navigation -->
            <button class="nav-btn mode-multi hidden" data-section="multi-upload-section">
                <span class="nav-icon">üìÅ</span>
                <span class="nav-label">Upload</span>
            </button>
            <button class="nav-btn mode-multi hidden" data-section="multi-periods-section">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-label">Per√≠odos</span>
            </button>
            <button class="nav-btn mode-multi hidden" data-section="multi-analytics-section">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Analytics</span>
            </button>
            <button class="nav-btn mode-multi hidden" data-section="multi-calculation-section">
                <span class="nav-icon">üßÆ</span>
                <span class="nav-label">C√°lculo DIFAL</span>
            </button>
            <button class="nav-btn mode-multi hidden" data-section="multi-reports-section">
                <span class="nav-icon">üìà</span>
                <span class="nav-label">Relat√≥rios</span>
            </button>
        </nav>

        <!-- Conte√∫do Principal -->
        <main class="main-content">
            
            <!-- =========================== MODE SELECTION SCREEN =========================== -->
            
            <!-- Initial Mode Selection -->
            <section id="mode-selection-section" class="section active" style="display: block !important;">
                <div class="section-card">
                    <div class="mode-selection-hero">
                        <h2 class="mode-selection-title">üöÄ Sistema DIFAL</h2>
                        <p class="mode-selection-subtitle">Escolha o modo de processamento para come√ßar</p>
                    </div>
                    
                    <!-- Seletor de Modo Principal -->
                    <div class="mode-selector-main">
                        <div class="mode-options-main">
                            <div class="mode-card" data-mode="single" id="single-mode-card">
                                <div class="mode-card-header">
                                    <span class="mode-card-icon">üìÑ</span>
                                    <h3 class="mode-card-title">Per√≠odo √önico</h3>
                                </div>
                                <div class="mode-card-content">
                                    <p class="mode-card-desc">Upload e an√°lise de um arquivo SPED</p>
                                    <ul class="mode-card-features">
                                        <li>‚úÖ Upload de arquivo SPED √∫nico</li>
                                        <li>‚úÖ An√°lise b√°sica de itens DIFAL</li>  
                                        <li>‚úÖ Configura√ß√£o e c√°lculo tradicional</li>
                                        <li>‚úÖ Exporta√ß√£o Excel/PDF</li>
                                    </ul>
                                </div>
                                <div class="mode-card-footer">
                                    <button class="btn btn-primary btn-large mode-select-btn" data-mode="single">
                                        Selecionar Per√≠odo √önico
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mode-card" data-mode="multi" id="multi-mode-card">
                                <div class="mode-card-header">
                                    <span class="mode-card-icon">üìÖ</span>
                                    <h3 class="mode-card-title">M√∫ltiplos Per√≠odos</h3>
                                </div>
                                <div class="mode-card-content">
                                    <p class="mode-card-desc">Upload de v√°rios arquivos da mesma empresa</p>
                                    <ul class="mode-card-features">
                                        <li>‚úÖ Upload sequencial de m√∫ltiplos SPEDs</li>
                                        <li>‚úÖ Consolida√ß√£o autom√°tica de dados</li>
                                        <li>‚úÖ An√°lise de Pareto (80/20)</li>
                                        <li>‚úÖ Relat√≥rios executivos avan√ßados</li>
                                    </ul>
                                </div>
                                <div class="mode-card-footer">
                                    <button id="multi-period-btn" class="btn btn-success btn-large mode-select-btn" data-mode="multi">
                                        Selecionar M√∫ltiplos Per√≠odos
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mode Selection Info -->
                    <div class="mode-selection-info">
                        <div class="info-box">
                            <h4>üí° Como escolher?</h4>
                            <p><strong>Per√≠odo √önico:</strong> Ideal para an√°lise pontual de um arquivo SPED espec√≠fico</p>
                            <p><strong>M√∫ltiplos Per√≠odos:</strong> Ideal para an√°lise temporal e insights estrat√©gicos consolidados</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- =========================== SINGLE-PERIOD SECTIONS =========================== -->
            
            <!-- Single-Period: Upload de Arquivo -->
            <section id="single-upload-section" class="section mode-single hidden" style="display: none;">
                <div class="section-card">
                    <h2 class="section-title">üìÅ Upload do Arquivo SPED - Per√≠odo √önico</h2>
                    
                    <!-- Mode Indicator -->
                    <div class="mode-indicator">
                        <span class="mode-badge single">üìÑ Per√≠odo √önico</span>
                        <button class="btn btn-outline btn-sm" onclick="window.modeManager?.handleModeSwitch()">
                            üîÑ Trocar Modo
                        </button>
                    </div>
                    
                    <!-- Drop Zone -->
                    <div id="drop-zone" class="drop-zone">
                        <div class="drop-zone-content">
                            <svg class="drop-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <p class="drop-text">Arraste o arquivo SPED aqui ou clique para selecionar</p>
                            <p class="drop-hint">Arquivo TXT do SPED Fiscal</p>
                            <input type="file" id="file-input" accept=".txt" style="display: none;">
                        </div>
                    </div>

                    <!-- Informa√ß√µes do Per√≠odo -->
                    <div id="file-info" class="file-info hidden">
                        <h3>üìÖ Informa√ß√µes do Per√≠odo</h3>
                        <div id="file-details" class="file-details">
                            <!-- Dados ser√£o inseridos via JavaScript -->
                        </div>
                    </div>

                    <!-- Resumo SPED -->
                    <div id="sped-summary" class="sped-summary hidden">
                        <h3>Resumo dos Dados SPED</h3>
                        <div class="summary-grid">
                            <!-- Dados ser√£o inseridos via JavaScript -->
                        </div>
                    </div>

                    <!-- Bot√£o Prosseguir -->
                    <div class="action-buttons">
                        <button id="single-proceed-analysis" class="btn btn-primary btn-large hidden">
                            Prosseguir para An√°lise ‚Üí
                        </button>
                    </div>
                </div>
            </section>

            <!-- Single-Period: An√°lise dos Dados -->
            <section id="single-analysis-section" class="section mode-single">
                <div class="section-card">
                    <h2 class="section-title">üîç An√°lise dos Itens DIFAL</h2>
                    
                    <!-- Informa√ß√µes da Empresa -->
                    <div class="company-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Empresa:</span>
                                <span id="single-company-name" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">UF:</span>
                                <span id="single-company-uf" class="info-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Itens DIFAL -->
                    <div id="single-difal-items-table" class="table-container">
                        <!-- Tabela ser√° inserida via JavaScript -->
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="action-buttons">
                        <button id="single-calculate-difal" class="btn btn-primary btn-large">
                            üéØ Configurar e Calcular DIFAL
                        </button>
                        <button id="single-proceed-to-calculation" class="btn btn-info">
                            Prosseguir para C√°lculo ‚Üí
                        </button>
                        <button class="btn btn-secondary nav-btn" data-section="single-upload-section">
                            ‚Üê Voltar para Upload
                        </button>
                    </div>
                </div>
            </section>

            <!-- Single-Period: Configura√ß√£o e C√°lculo -->
            <section id="single-calculation-section" class="section mode-single">
                <div class="section-card">
                    <h2 class="section-title">‚öôÔ∏è Configura√ß√£o e C√°lculo</h2>
                    
                    <!-- Progress Section -->
                    <div id="single-progress-section" class="progress-section hidden">
                        <div class="progress-container">
                            <div id="single-progress-bar" class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <p id="single-status-message" class="status-message">Processando...</p>
                        </div>
                    </div>

                    <!-- Resultados do C√°lculo -->
                    <div id="single-calculation-results" class="calculation-results hidden">
                        <div id="single-results-summary" class="results-summary">
                            <!-- Resumo ser√° inserido via JavaScript -->
                        </div>
                        
                        <div id="single-results-detail" class="results-detail">
                            <!-- Detalhes ser√£o inseridos via JavaScript -->
                        </div>

                        <!-- Bot√µes de Exporta√ß√£o -->
                        <div class="export-buttons">
                            <button id="single-export-excel" class="btn btn-success">
                                üì• Exportar para Excel
                            </button>
                            <button id="single-export-pdf" class="btn btn-info">
                                üìÑ Exportar para PDF
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Single-Period: Resultados -->
            <section id="single-results-section" class="section mode-single">
                <div class="section-card">
                    <h2 class="section-title">üìã Resultados do C√°lculo DIFAL</h2>
                    
                    <div id="single-final-results" class="final-results">
                        <!-- Resultados finais ser√£o inseridos via JavaScript -->
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary nav-btn" data-section="single-calculation-section">
                            ‚Üê Voltar para C√°lculo
                        </button>
                        <button id="single-new-calculation" class="btn btn-primary">
                            üîÑ Novo C√°lculo
                        </button>
                    </div>
                </div>
            </section>

            <!-- =========================== MULTI-PERIOD SECTIONS =========================== -->

            <!-- Multi-Period: Upload de Arquivos -->
            <section id="multi-upload-section" class="section mode-multi hidden">
                <div class="section-card">
                    <h2 class="section-title">üìÅ Upload de M√∫ltiplos Arquivos SPED - M√∫ltiplos Per√≠odos</h2>
                    
                    <!-- Mode Indicator -->
                    <div class="mode-indicator">
                        <span class="mode-badge multi">üìÖ M√∫ltiplos Per√≠odos</span>
                        <button class="btn btn-outline btn-sm" onclick="window.modeManager?.handleModeSwitch()">
                            üîÑ Trocar Modo
                        </button>
                    </div>
                    
                    <!-- Upload para M√∫ltiplos Per√≠odos -->
                    <div class="multi-period-upload">
                        <div class="upload-instructions">
                            <h3>üìÅ Upload de Arquivos SPED por Per√≠odo</h3>
                            <p>Fa√ßa upload de m√∫ltiplos arquivos SPED da mesma empresa em per√≠odos diferentes para an√°lise consolidada.</p>
                            <ul class="instructions-list">
                                <li>‚úÖ Todos os arquivos devem ser da mesma empresa (mesmo CNPJ)</li>
                                <li>‚úÖ Per√≠odos n√£o podem sobrepor</li>
                                <li>‚úÖ M√°ximo de 12 per√≠odos por empresa</li>
                                <li>‚úÖ Sistema detecta automaticamente empresa e per√≠odo</li>
                            </ul>
                        </div>
                        
                        <div id="multi-period-drop-zone" class="drop-zone">
                            <div class="drop-zone-content">
                                <svg class="drop-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <p class="drop-text">Arraste arquivos SPED aqui ou clique para selecionar m√∫ltiplos arquivos</p>
                                <p class="drop-hint">Arquivos TXT do SPED Fiscal - Mesmo CNPJ, per√≠odos distintos</p>
                                <input type="file" id="multi-period-file-input" accept=".txt" multiple style="display: none;">
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="action-buttons">
                        <button id="multi-proceed-periods" class="btn btn-primary btn-large hidden">
                            Prosseguir para Per√≠odos ‚Üí
                        </button>
                    </div>
                </div>
            </section>

            <!-- Multi-Period: Gest√£o de Per√≠odos -->
            <section id="multi-periods-section" class="section mode-multi hidden">
                <div class="section-card">
                    <h2 class="section-title">üìÖ Gest√£o de M√∫ltiplos Per√≠odos</h2>
                    
                    <!-- Informa√ß√µes da Empresa Atual -->
                    <div id="multi-current-company-info" class="company-info hidden">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Empresa:</span>
                                <span id="multi-current-company-name" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">CNPJ:</span>
                                <span id="multi-current-company-cnpj" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">UF:</span>
                                <span id="multi-current-company-uf" class="info-value">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Per√≠odos:</span>
                                <span id="multi-current-company-periods" class="info-value">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Per√≠odos Carregados -->
                    <div id="multi-periods-list" class="periods-list hidden">
                        <h3>üìä Per√≠odos Carregados</h3>
                        <div id="multi-periods-table" class="table-container">
                            <!-- Tabela de per√≠odos ser√° inserida via JavaScript -->
                        </div>
                    </div>

                    <!-- Estat√≠sticas Consolidadas -->
                    <div id="multi-consolidated-stats" class="consolidated-stats hidden">
                        <h3>üìà Estat√≠sticas Consolidadas</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="multi-consolidated-total-items">0</div>
                                <div class="stat-label">Total de Itens</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="multi-consolidated-total-value">R$ 0</div>
                                <div class="stat-label">Valor Total</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="multi-consolidated-unique-ncms">0</div>
                                <div class="stat-label">NCMs √önicos</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="multi-consolidated-periods-count">0</div>
                                <div class="stat-label">Per√≠odos</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="action-buttons">
                        <button id="multi-clear-all-periods" class="btn btn-secondary">
                            üßπ Limpar Todos os Per√≠odos
                        </button>
                        <button id="multi-generate-analytics" class="btn btn-primary">
                            üìä Gerar An√°lises Estat√≠sticas
                        </button>
                        <button id="multi-proceed-to-analytics" class="btn btn-success">
                            üìà Ver Analytics ‚Üí
                        </button>
                        <button class="btn btn-secondary nav-btn" data-section="multi-upload-section">
                            ‚Üê Voltar para Upload
                        </button>
                    </div>
                </div>
            </section>

            <!-- Multi-Period: Analytics -->
            <section id="multi-analytics-section" class="section mode-multi hidden">
                <div class="section-card">
                    <h2 class="section-title">üìä Analytics Estat√≠sticas Consolidadas</h2>
                    
                    <!-- Resumo das An√°lises -->
                    <div id="multi-analytics-summary" class="analytics-summary hidden">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="multi-analytics-total-value">R$ 0</div>
                                <div class="summary-label">Valor Total Analisado</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="multi-analytics-pareto-ncms">0</div>
                                <div class="summary-label">NCMs Pareto (80%)</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="multi-analytics-concentration">0%</div>
                                <div class="summary-label">Taxa de Concentra√ß√£o</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="multi-analytics-top-ncm">-</div>
                                <div class="summary-label">NCM Principal</div>
                            </div>
                        </div>
                    </div>

                    <!-- Abas de Analytics -->
                    <div id="multi-analytics-tabs" class="tabs-container hidden">
                        <div class="tabs-header">
                            <button class="tab-btn active" data-tab="multi-pareto-tab">üìà An√°lise Pareto</button>
                            <button class="tab-btn" data-tab="multi-ncm-tab">üè∑Ô∏è Ranking NCM</button>
                            <button class="tab-btn" data-tab="multi-trends-tab">üìä Tend√™ncias</button>
                            <button class="tab-btn" data-tab="multi-charts-tab">üìâ Gr√°ficos</button>
                        </div>
                        
                        <!-- Aba: An√°lise Pareto -->
                        <div id="multi-pareto-tab" class="tab-content active">
                            <div id="multi-pareto-analysis" class="analysis-content">
                                <!-- Conte√∫do da an√°lise Pareto ser√° inserido via JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Aba: Ranking NCM -->
                        <div id="multi-ncm-tab" class="tab-content">
                            <div id="multi-ncm-ranking" class="analysis-content">
                                <!-- Ranking de NCMs ser√° inserido via JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Aba: Tend√™ncias -->
                        <div id="multi-trends-tab" class="tab-content">
                            <div id="multi-trends-analysis" class="analysis-content">
                                <!-- An√°lise de tend√™ncias ser√° inserida via JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Aba: Gr√°ficos -->
                        <div id="multi-charts-tab" class="tab-content">
                            <div id="multi-charts-dashboard" class="analysis-content">
                                <!-- Dashboard de gr√°ficos ser√° inserido via JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Progress Section para Analytics -->
                    <div id="multi-analytics-progress-section" class="progress-section hidden">
                        <div class="progress-container">
                            <div id="multi-analytics-progress-bar" class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <p id="multi-analytics-status-message" class="status-message">Processando an√°lises...</p>
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="action-buttons">
                        <button id="multi-proceed-to-reports" class="btn btn-success">
                            üìà Ver Relat√≥rios ‚Üí
                        </button>
                        <button class="btn btn-secondary nav-btn" data-section="multi-periods-section">
                            ‚Üê Voltar para Per√≠odos
                        </button>
                    </div>
                </div>
            </section>

            <!-- Multi-Period: C√°lculo DIFAL -->
            <section id="multi-calculation-section" class="section mode-multi hidden">
                <div class="section-card">
                    <h2 class="section-title">üßÆ C√°lculo DIFAL Multi-Per√≠odo</h2>
                    
                    <!-- Resumo Consolidado -->
                    <div id="multi-calculation-summary" class="calculation-summary">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="multi-total-periods">-</div>
                                <div class="summary-label">Per√≠odos</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="multi-total-items">-</div>
                                <div class="summary-label">Itens DIFAL</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="multi-total-value">R$ -</div>
                                <div class="summary-label">Valor Total</div>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√£o DIFAL -->
                    <div class="config-section">
                        <h3>‚öôÔ∏è Configura√ß√£o DIFAL</h3>
                        <div class="config-grid">
                            <div class="config-item">
                                <label for="multi-uf-origem">UF da Empresa (extra√≠da do SPED):</label>
                                <div id="multi-uf-origem" class="form-control readonly">
                                    <span id="multi-uf-display" class="uf-display">-</span>
                                </div>
                            </div>
                            <div class="config-item">
                                <label for="multi-aliquota-interna">Al√≠quota Interna (%):</label>
                                <input type="number" id="multi-aliquota-interna" class="form-control" 
                                       value="18" min="0" max="25" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Bot√£o de C√°lculo -->
                    <div class="calculation-actions">
                        <button id="multi-calculate-difal-btn" class="btn btn-primary btn-lg">
                            üßÆ Calcular DIFAL Multi-Per√≠odo
                        </button>
                    </div>

                    <!-- Tabela de Resultados -->
                    <div id="multi-calculation-results" class="results-section hidden">
                        <h3>üìä Resultados do C√°lculo DIFAL</h3>
                        <div class="table-container">
                            <table id="multi-difal-results-table" class="data-table">
                                <thead>
                                    <tr>
                                        <th>NCM</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor Base</th>
                                        <th>Al√≠q. Origem</th>
                                        <th>Al√≠q. Destino</th>
                                        <th>DIFAL</th>
                                        <th>FCP</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Navega√ß√£o -->
                    <div class="section-nav">
                        <button class="btn btn-secondary nav-btn" data-section="multi-analytics-section">
                            ‚Üê Analytics
                        </button>
                        <button class="btn btn-secondary nav-btn" data-section="multi-reports-section">
                            Relat√≥rios ‚Üí
                        </button>
                    </div>
                </div>
            </section>

            <!-- Multi-Period: Relat√≥rios -->
            <section id="multi-reports-section" class="section mode-multi hidden">
                <div class="section-card">
                    <h2 class="section-title">üìà Relat√≥rios Executivos</h2>
                    
                    <!-- Bot√µes de Exporta√ß√£o de Relat√≥rios -->
                    <div id="multi-reports-export-buttons" class="export-buttons">
                        <button id="multi-export-analytics-excel" class="btn btn-success">
                            üì• Exportar An√°lises (Excel)
                        </button>
                        <button id="multi-export-analytics-pdf" class="btn btn-info">
                            üìÑ Relat√≥rio Pareto (PDF)
                        </button>
                        <button id="multi-export-consolidated-report" class="btn btn-primary">
                            üìä Relat√≥rio Consolidado
                        </button>
                    </div>

                    <!-- Dashboard de Relat√≥rios -->
                    <div id="multi-reports-dashboard" class="reports-dashboard">
                        <!-- Dashboard ser√° inserido via JavaScript -->
                    </div>

                    <!-- Bot√µes de Navega√ß√£o -->
                    <div class="action-buttons">
                        <button class="btn btn-secondary nav-btn" data-section="multi-analytics-section">
                            ‚Üê Voltar para Analytics
                        </button>
                        <button id="multi-refresh-reports" class="btn btn-info">
                            üîÑ Atualizar Relat√≥rios
                        </button>
                    </div>
                </div>
            </section>


        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>¬© 2025 Expertzy - Sistema de C√°lculo DIFAL v3.0</p>
            <p class="footer-info">C√°lculo conforme legisla√ß√£o vigente - EC 87/2015</p>
        </footer>
    </div>

    <!-- Modal de Configura√ß√£o Geral -->
    <div id="config-modal" class="modal hidden">
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚öôÔ∏è Configura√ß√£o Geral do DIFAL</h2>
                    <button class="modal-close" onclick="closeConfigModal()">√ó</button>
                </div>
                
                <div class="modal-body">
                    <!-- Sele√ß√£o de Metodologia -->
                    <div class="form-section">
                        <h3>üìê Metodologia de C√°lculo</h3>
                        <p class="form-description">Escolha a metodologia de c√°lculo a ser aplicada para todos os itens</p>
                        
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="metodologia" value="auto" checked>
                                <span class="radio-label">
                                    <strong>Autom√°tica</strong>
                                    <small>Sistema define baseado no estado de destino</small>
                                </span>
                            </label>
                            
                            <label class="radio-option">
                                <input type="radio" name="metodologia" value="base-unica">
                                <span class="radio-label">
                                    <strong>Base √önica</strong>
                                    <small>C√°lculo simplificado</small>
                                </span>
                            </label>
                            
                            <label class="radio-option">
                                <input type="radio" name="metodologia" value="base-dupla">
                                <span class="radio-label">
                                    <strong>Base Dupla</strong>
                                    <small>C√°lculo com IPI incluso</small>
                                </span>
                            </label>
                        </div>
                    </div>

                    <!-- Benef√≠cios Fiscais Globais -->
                    <div class="form-section">
                        <h3>üí∞ Benef√≠cios Fiscais Globais</h3>
                        <p class="form-description">Configure benef√≠cios aplic√°veis a todos os itens</p>
                        
                        <div class="form-group">
                            <label for="carga-efetiva">Carga Tribut√°ria Efetiva (%):</label>
                            <input type="number" id="carga-efetiva" value="" min="0" max="100" step="0.01" placeholder="Ex: 4.00">
                            <small class="form-hint">Deixe vazio para n√£o aplicar redu√ß√£o de base. Sistema calcular√° automaticamente o percentual de redu√ß√£o necess√°rio.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="aliq-origem-efetiva">Al√≠quota Origem Efetiva (%):</label>
                            <input type="number" id="aliq-origem-efetiva" value="" min="0" max="100" step="0.01" placeholder="Ex: 10.00">
                            <small class="form-hint">Deixe vazio para usar al√≠quota nominal. Aplic√°vel apenas para Base √önica.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="aliq-destino-efetiva">Al√≠quota Destino Efetiva (%):</label>
                            <input type="number" id="aliq-destino-efetiva" value="" min="0" max="100" step="0.01" placeholder="Ex: 17.00">
                            <small class="form-hint">Deixe vazio para usar al√≠quota nominal.</small>
                        </div>
                    </div>

                    <!-- Configura√ß√µes Avan√ßadas -->
                    <div class="form-section">
                        <h3>üîß Configura√ß√µes Avan√ßadas</h3>
                        
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" id="configurar-beneficios" checked>
                                <span>Configurar benef√≠cios fiscais por item</span>
                            </label>
                            
                            <label class="checkbox-option">
                                <input type="checkbox" id="configurar-fcp-manual">
                                <span>Definir FCP manualmente por item</span>
                            </label>
                        </div>
                    </div>

                    <!-- Percentual do Destinat√°rio -->
                    <div class="form-section">
                        <h3>üìä Partilha do DIFAL</h3>
                        <div class="form-group">
                            <label for="percentual-destinatario">Percentual para o Estado de Destino:</label>
                            <input type="number" id="percentual-destinatario" value="100" min="0" max="100" readonly>
                            <small class="form-hint">Para 2025: 100% para o estado de destino</small>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeConfigModal()">Cancelar</button>
                    <button class="btn btn-warning" onclick="prosseguirParaConfiguracaoItens()">
                        ‚öôÔ∏è Configurar Itens Individualmente
                    </button>
                    <button class="btn btn-primary" onclick="calcularSemConfiguracaoItens()">
                        üöÄ Calcular Sem Configura√ß√£o Individual
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o Por Item -->
    <div id="item-config-modal" class="modal hidden">
        <div class="modal-overlay">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>üìã Configura√ß√£o Individual por Item</h2>
                    <button class="modal-close" onclick="closeItemConfigModal()">√ó</button>
                </div>
                
                <div class="modal-body">
                    <!-- Filtros -->
                    <div class="filters-section">
                        <div class="filters-grid">
                            <div class="filter-item">
                                <label for="filtro-cfop">CFOP:</label>
                                <select id="filtro-cfop">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="filtro-ncm">NCM:</label>
                                <select id="filtro-ncm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="filtro-valor-min">Valor M√≠nimo:</label>
                                <input type="number" id="filtro-valor-min" placeholder="0.00" min="0" step="0.01">
                            </div>
                            <div class="filter-item">
                                <label for="busca-item">Buscar:</label>
                                <input type="text" id="busca-item" placeholder="C√≥digo ou descri√ß√£o...">
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="aplicarFiltros()">Aplicar Filtros</button>
                            <button class="btn btn-outline btn-sm" onclick="limparFiltros()">Limpar</button>
                        </div>
                    </div>

                    <!-- Resumo -->
                    <div class="config-summary">
                        <div class="summary-stats">
                            <span>Total de Itens: <strong id="total-itens-config">0</strong></span>
                            <span>Com Benef√≠cio: <strong id="itens-com-beneficio">0</strong></span>
                            <span>Valor Total Base: <strong id="valor-total-base">R$ 0,00</strong></span>
                            <span>Configs Salvas: <strong id="configs-localstorage">0</strong></span>
                        </div>
                        <div class="storage-status" id="storage-status">
                            <small>üì± Dados ser√£o mantidos entre sess√µes</small>
                        </div>
                    </div>

                    <!-- Tabela de Configura√ß√£o -->
                    <div class="config-table-container">
                        <table id="tabela-configuracao-itens" class="data-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>NCM</th>
                                    <th>Descri√ß√£o</th>
                                    <th>CFOP</th>
                                    <th>Valor Base</th>
                                    <th>Benef√≠cio</th>
                                    <th>Configura√ß√£o</th>
                                    <th>FCP (%)</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Linhas ser√£o inseridas via JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagina√ß√£o -->
                    <div id="paginacao-config" class="pagination">
                        <button class="btn btn-sm btn-secondary" onclick="paginaAnterior()">‚Üê Anterior</button>
                        <span id="info-pagina" class="page-info">P√°gina 1 de 1</span>
                        <button class="btn btn-sm btn-secondary" onclick="proximaPagina()">Pr√≥ximo ‚Üí</button>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeItemConfigModal()">Cancelar</button>
                    <button class="btn btn-warning" onclick="limparTodasConfiguracoes()">üßπ Limpar Todas</button>
                    <button class="btn btn-info" onclick="salvarConfiguracoesItens()">üíæ Salvar Configura√ß√µes</button>
                    <button class="btn btn-primary" onclick="calcularComConfiguracoesItens()">
                        üéØ Calcular com Configura√ß√µes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Fun√ß√µes inline removidas - migradas para m√≥dulos respectivos:
         - Modal functions ‚Üí js/modal/modal-manager.js
         - Configuration functions ‚Üí js/core/configuration-manager.js  
         - UI functions ‚Üí js/ui-manager.js
    -->
    
    <!-- M√≥dulos Core (Infraestrutura) -->
    <script src="js/core/constants.js"></script>
    <script src="js/core/event-bus.js"></script>
    <script src="js/core/state-manager.js"></script>
    <!-- single-period-manager.js - functionality integrated into ui-manager.js -->
    <script src="js/core/mode-manager.js"></script>
    <script src="js/core/logger.js"></script>
    
    <!-- M√≥dulos de Configura√ß√£o -->
    <script src="js/config/configuration-manager.js"></script>
    
    <!-- M√≥dulos Modulares -->
    <script src="data/estados-brasil.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/parsing/sped-parser.js"></script>
    <script src="js/calculation/difal-calculator-simple.js"></script>
    
    <!-- Novos M√≥dulos UI -->
    <script src="js/export/export-manager.js"></script>
    <script src="js/file/file-upload-manager.js"></script>
    <script src="js/modal/modal-manager.js"></script>
    <script src="js/results/results-renderer.js"></script>
    <script src="js/ui/navigation-manager.js"></script>
    <script src="js/ui/progress-manager.js"></script>
    <script src="js/ui/pagination-manager.js"></script>
    
    <!-- M√≥dulos de M√∫ltiplos Per√≠odos e Analytics -->
    <script src="js/periods/periods-manager.js"></script>
    <script src="js/periods/multi-period-manager.js"></script>
    <script src="js/analytics/analytics-manager.js"></script>
    <script src="js/analytics/pareto-analyzer.js"></script>
    <script src="js/charts/charts-manager.js"></script>
    
    <!-- UI Manager Principal -->
    <script src="js/ui-manager.js"></script>
    
    <!-- App Principal -->
    <script src="js/app.js"></script>
    
    <!-- Mode Selection Handler -->
    <script>
        // Mode Selection Event Handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Aguardar inicializa√ß√£o da aplica√ß√£o
            setTimeout(function() {
                const modeSelectButtons = document.querySelectorAll('.mode-select-btn');
                const modeSelectionSection = document.getElementById('mode-selection-section');
                const navigation = document.getElementById('main-navigation');
                
                console.log('üéØ Configurando handlers da sele√ß√£o de modo...');
                
                modeSelectButtons.forEach(button => {
                    button.addEventListener('click', async function() {
                        const selectedMode = this.getAttribute('data-mode');
                        console.log(`üéØ Modo selecionado: ${selectedMode}`);
                        
                        // Verificar se ModeManager est√° dispon√≠vel
                        if (!window.modeManager) {
                            console.error('‚ùå ModeManager n√£o dispon√≠vel');
                            alert('Sistema ainda n√£o foi inicializado. Tente novamente em alguns segundos.');
                            return;
                        }
                        
                        console.log('üîß ModeManager dispon√≠vel, definindo modo...');
                        
                        try {
                            // Definir modo no ModeManager
                            const result = await window.modeManager.setMode(selectedMode);
                            console.log(`üîß Resultado do setMode: ${result}`);
                            
                            if (result) {
                                // Esconder sele√ß√£o de modo
                                modeSelectionSection.classList.add('hidden');
                                modeSelectionSection.classList.remove('active');
                                
                                // Mostrar navega√ß√£o
                                navigation.classList.remove('hidden');
                                
                                console.log(`‚úÖ Interface mudou para modo: ${selectedMode}`);
                            }
                        } catch (error) {
                            console.error('‚ùå Erro ao definir modo:', error);
                            alert(`Erro ao carregar modo ${selectedMode}: ${error.message}`);
                        }
                    });
                });
                
                console.log(`‚úÖ ${modeSelectButtons.length} bot√µes de sele√ß√£o de modo configurados`);
            }, 1000); // Aguardar 1 segundo para garantir inicializa√ß√£o
        });
        
        // Global mode switch handler for "Trocar Modo" buttons
        window.handleModeSwitch = function() {
            console.log('üîÑ Iniciando troca de modo...');
            
            if (!window.modeManager) {
                console.error('‚ùå ModeManager n√£o dispon√≠vel para troca de modo');
                return;
            }
            
            // Esconder navega√ß√£o
            const navigation = document.getElementById('main-navigation');
            if (navigation) {
                navigation.classList.add('hidden');
            }
            
            // Esconder todas as se√ß√µes
            const allSections = document.querySelectorAll('.section:not(#mode-selection-section)');
            allSections.forEach(section => {
                section.classList.remove('active');
                section.classList.add('hidden');
            });
            
            // Mostrar sele√ß√£o de modo
            const modeSelectionSection = document.getElementById('mode-selection-section');
            if (modeSelectionSection) {
                modeSelectionSection.classList.remove('hidden');
                modeSelectionSection.classList.add('active');
            }
            
            console.log('‚úÖ Voltou para sele√ß√£o de modo');
        };
    </script>
    
</body>
</html>